# Prometheus Task Coordinator - Docker Container
# Base image: ROS2 Humble
FROM osrf/ros:humble-desktop

# Set working directory
WORKDIR /workspace

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3-pip \
    python3-colcon-common-extensions \
    python3-rosdep \
    python3-vcstool \
    git \
    vim \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip3 install \
    flask \
    flask-cors \
    paho-mqtt \
    pytest \
    pytest-cov

# Create ROS2 workspace
RUN mkdir -p /workspace/ros2_ws/src

# Set up ROS2 environment
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
RUN echo "source /workspace/ros2_ws/install/setup.bash" >> ~/.bashrc

# Copy package to workspace
COPY . /workspace/ros2_ws/src/prometheus_task_coordinator/

# Set working directory to ROS2 workspace
WORKDIR /workspace/ros2_ws

# Build the package
RUN . /opt/ros/humble/setup.sh && \
    colcon build --symlink-install

# Source the workspace
RUN echo "source /workspace/ros2_ws/install/setup.bash" >> ~/.bashrc

# Expose ports
EXPOSE 5000

# Default command
CMD ["/bin/bash", "-c", "source /opt/ros/humble/setup.bash && source /workspace/ros2_ws/install/setup.bash && ros2 launch prometheus_task_coordinator task_coordinator.launch.py"]