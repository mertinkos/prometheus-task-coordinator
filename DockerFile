# Prometheus Görev Koordinatörü - Docker Konteyneri
# Temel imaj: ROS2 Humble
FROM osrf/ros:humble-desktop

# Çalışma dizinini ayarla
WORKDIR /workspace

# Sistem bağımlılıklarını yükle
RUN apt-get update && apt-get install -y \
    python3-pip \
    python3-colcon-common-extensions \
    python3-rosdep \
    python3-vcstool \
    git \
    vim \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python bağımlılıklarını yükle
RUN pip3 install \
    flask \
    flask-cors \
    paho-mqtt \
    pytest \
    pytest-cov

# ROS2 çalışma alanını oluştur
RUN mkdir -p /workspace/ros2_ws/src

# ROS2 ortamını ayarla
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
RUN echo "source /workspace/ros2_ws/install/setup.bash" >> ~/.bashrc

# Paketi çalışma alanına kopyala
COPY . /workspace/ros2_ws/src/prometheus_task_coordinator/

# Çalışma dizinini ROS2 çalışma alanına değiştir
WORKDIR /workspace/ros2_ws

# Paketi derle (build)
RUN . /opt/ros/humble/setup.sh && \
    colcon build --symlink-install

# Çalışma alanını kaynak (source) olarak ekle
RUN echo "source /workspace/ros2_ws/install/setup.bash" >> ~/.bashrc

# Portları dışa aç
EXPOSE 5000

# Varsayılan komut: Ortamı yükle ve başlatma dosyasını (launch file) çalıştır
CMD ["/bin/bash", "-c", "source /opt/ros/humble/setup.bash && source /workspace/ros2_ws/install/setup.bash && ros2 launch prometheus_task_coordinator task_coordinator.launch.py"]